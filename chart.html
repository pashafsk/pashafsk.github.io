<!DOCTYPE html>
   <head >
      <title>Moving Averages</title>
      <script src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
	  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	  
	  <style>
	  .trend tr:nth-child(even) {background-color: #f2f2f2;}
	  .ma tr:nth-child(even) {background-color: gray;}
	  
		table, th, td {
  border: 1px solid black;
}
	  
	 
	  </style>
	  
   </head>

   <body>
   
   <input type="text" id="tickerSymbol" />
   <button>Go!</button>
    <div class =  "symbol"> </div>
    <div class = "trend"> </div>
	<div class = "ma"> </div>
	<div class = "notes"> </div>
   
   <script>
    var getData = function(){
        var input = $('#tickerSymbol').val();
        var found = false;
        var iex = 'https://api.iextrading.com/1.0/stock/'+input+'/price';
  
        $.ajax({ 
            url: iex, 
            dataType: 'json', 
            async: false, 
            success: function(data){ 
              price = data;
            } 
           });
  
        var chart = 'https://api.iextrading.com/1.0/stock/'+input+'/chart/1y';
		
		
		 var value=[];
		 var weekly=[];
		 
		$.getJSON(chart, function(data){
			$.each(data, function(index, daily){
			  //  console.log(daily.close);
				value.push(daily.close);
				   // console.log(daily.date);
					var d = new Date(daily.date);
					//console.log(d +'day is'+ d.getDay());
				if (d.getDay() == 4){
					weekly.push(daily.close);
					}
				})
			 			  				 
			  //5ma trend
			  var x5ma =  value.slice(value.length-5,value.length).reduceRight(getSum);
			  var y5ma =  value.slice(value.length-6,value.length-1).reduceRight(getSum);
			  var z5ma =  value.slice(value.length-7,value.length-2).reduceRight(getSum);
              var Today5 =  value.slice(value.length-4,value.length).reduceRight(getSum);
              //console.log('price'+ price);
              Today5 =((Today5+price)/5).toFixed(2);
			  //end 5ma trend
			  
			  //10ma trend
			  var x10ma =  value.slice(value.length-10,value.length).reduceRight(getSum);
			  var y10ma =  value.slice(value.length-11,value.length-1).reduceRight(getSum);
			  var z10ma =  value.slice(value.length-12,value.length-2).reduceRight(getSum);
              var Today10 =  value.slice(value.length-9,value.length).reduceRight(getSum);
              Today10 =((Today10+price)/10).toFixed(2);
              //end 10ma trend
			  
			  //20ma trend
			  var x20ma =  value.slice(value.length-20,value.length).reduceRight(getSum);
			  var y20ma =  value.slice(value.length-21,value.length-1).reduceRight(getSum);
			  var z20ma =  value.slice(value.length-22,value.length-2).reduceRight(getSum);
              var Today20 =  value.slice(value.length-19,value.length).reduceRight(getSum);
              //console.log('price'+ price);
              Today20 =((Today20+price)/20).toFixed(2);
			  //end 20ma trend
			  
			  //50ma trend
			  var x50ma =  value.slice(value.length-50,value.length).reduceRight(getSum);
			  var y50ma =  value.slice(value.length-51,value.length-1).reduceRight(getSum);
			  var z50ma =  value.slice(value.length-52,value.length-2).reduceRight(getSum);
              var Today50 =  value.slice(value.length-49,value.length).reduceRight(getSum);
              //console.log('price'+ price);
              Today50 =((Today50+price)/50).toFixed(2);
			  //end 50ma trend
			  
			  //100 and 200 ma calc
			  var x100ma =  value.slice(value.length-100,value.length).reduceRight(getSum);
			  var x200ma =  value.slice(value.length-200,value.length).reduceRight(getSum);
			  //console.log('100 dma is ' + (x100ma/100).toFixed(2) + ' 200 dma is ' + (x200ma/200).toFixed(2));
			  //end 100 and 200 ma calc
			  
			  //weekly 5ma
			  var x5wma =  weekly.slice(weekly.length-5,weekly.length).reduceRight(getSum);
			  var y5wma =  weekly.slice(weekly.length-6,weekly.length-1).reduceRight(getSum);
			  var z5wma =  weekly.slice(weekly.length-7,weekly.length-2).reduceRight(getSum);
              //var Today5 =  value.slice(value.length-4,value.length).reduceRight(getSum);
              //console.log('price'+ price);
              //Today5 =((Today5+price)/5).toFixed(2);
			  //weekly 10 sam
			  
			  var x10wma =  weekly.slice(weekly.length-10,weekly.length).reduceRight(getSum);
			  var y10wma =  weekly.slice(weekly.length-11,weekly.length-1).reduceRight(getSum);
			  var z10wma =  weekly.slice(weekly.length-12,weekly.length-2).reduceRight(getSum);


			  //var rgbColor = data.quote.changePercent > 0 ? '0,255,0' : '255,0,0';
              //var  rgbOpacity = Math.min(Math.abs(data.quote.changePercent) * 20, 1);
			  
			  //create table of trend
			  
			  var table = '<br><table>';
               table += '<th>MovingAverage</th><th>2days</th><th>yesterday</th><th>today</th><th>current</th>';
              
			    //table += '<tr>';
				//table += '<tr><td>' + '5ma trend ' +(z5ma/5).toFixed(2) + ' ' + (y5ma/5).toFixed(2) + ' ' + (x5ma/5).toFixed(2)+ '</td></tr>';
				table +='<tr>';
				   	table += '<td> 5SMA </td><td>'+ (z5ma/5).toFixed(2) + '</td>' + '<td>' + (y5ma/5).toFixed(2) + '</td>' + '<td>' + (x5ma/5).toFixed(2) + '</td>'+ '<td>'+ Today5 + '</td>';
				table += '</tr>';
				table +='<tr>';
				   	table += '<td> 10SMA </td><td>'+ (z10ma/10).toFixed(2) + '</td>' + '<td>' + (y10ma/10).toFixed(2) + '</td>' + '<td>' + (x10ma/10).toFixed(2) + '</td>'+ '<td>'+ Today10 + '</td>';
				table += '</tr>';
				table +='<tr>';
				   	table += '<td> 20SMA </td><td>'+ (z20ma/20).toFixed(2) + '</td>' + '<td>' + (y20ma/20).toFixed(2) + '</td>' + '<td>' + (x20ma/20).toFixed(2) + '</td>'+ '<td>'+ Today20 + '</td>';
				table += '</tr>';
				table +='<tr>';
				   	table += '<td> Price </td><td>'+ value[value.length-3]+ '</td>' + '<td>' + value[value.length-2] + '</td>' + '<td>' + value[value.length-1] + '</td>'+ '<td>'+ price + '</td>';
				table += '</tr>';
				table +='<tr>';
				   	table += '<td> 50SMA </td><td>'+ (z50ma/50).toFixed(2) + '</td>' + '<td>' + (y50ma/50).toFixed(2) + '</td>' + '<td>' + (x50ma/50).toFixed(2) + '</td>'+ '<td>'+ Today50 + '</td>';
				table += '</tr>';
				table +='<tr>';
				   	table += '<td> Weekly5 </td><td>'+ (z5wma/5).toFixed(2) + '</td>' + '<td>' + (y5wma/5).toFixed(2) + '</td>' + '<td>' + (x5wma/5).toFixed(2) + '</td>'+ '<td>'+ '' + '</td>';
				table += '</tr>';
				table +='<tr>';
				   	table += '<td> Weekly10 </td><td>'+ (z10wma/10).toFixed(2) + '</td>' + '<td>' + (y10wma/10).toFixed(2) + '</td>' + '<td>' + (x10wma/10).toFixed(2) + '</td>'+ '<td>'+ '' + '</td>';
				table += '</tr>';
			  table += '</table>';
		 $('.ma').html(table);
		 
		 
		 
		  var trend = [
						 [(x5ma/5).toFixed(2),"5MA"],
						 [(x10ma/10).toFixed(2),"10MA"],
						 [(x20ma/20).toFixed(2),"20MA"],
						 [(x50ma/50).toFixed(2),"50MA"],
						 [(x100ma/100).toFixed(2),"100MA"],
						 [(x200ma/200).toFixed(2),"200MA"],
						 //[entry.gsx$weekly5ma.$t,"Weekly5SMA"],
						 //[entry.gsx$weekly10sma.$t,"Weekly10SMA"],
						 [price,"Current Price"],
						 [(x5wma/5).toFixed(2),"Weekly5SMA"],
						 [(y10wma/10).toFixed(2),"Weekly10SMA"]
                                          						 
						]
					
			trend.sort();
			var now = new Date();
			$('.symbol').html('<br><br>'+input.toUpperCase()+' Last Updated ' + now +  '<br><br>');
			
						var html = '<table>';
							html += '<tr>';
						
							html += '</tr>';
							for( var i = 0; i < trend.length; i++) {
								html += '<tr>';
								   if(trend[i][1]== 'Current Price'){
										html += '<td><font color = "red">' + trend[i][1] + '</font></td>';
										html += '<td><font color = "red">' + trend[i][0]+'</font></td>';
										html += '</tr>';
										}
									
									else{
										html += '<td>' + trend[i][1] + '</td>';
										html += '<td>' + trend[i][0]+'</td>';
										html += '</tr>';
									}
                            
												 
							}
							
						
								html += '</table>';
							 $('.trend').html(html);
							 $('.notes').empty();
				if (x5wma> y5wma){
				       	  $('.notes').append('<font color = "green" size = "6">5ma weekly pointing up</font>' + '(' + (y5wma/5).toFixed(2)+')' );
						}
						else {
						$('.notes').append('<font color = "red" size = "6">5ma weekly pointing DOWN</font>' + '(' + (y5wma/5).toFixed(2) +')');
						}
											
				if (x10wma > y10wma){
						  $('.notes').append('<br><font color = "green" size = "6">10ma weekly pointing up</font>' + '(' + (y10wma/10).toFixed(2) +')');
						}
						else {
						$('.notes').append('<br><font color = "red" size = "6">10ma weekly pointing DOWN</font>' + '(' + (y10wma/10).toFixed(2) +')');
						}
				
						
			
			   
			function getSum(total, num) {
			         return total+num;
				}

		});        				    
    }//getdata
    
    $("input").change(getData);
    
    $(function() {
        var urlParams = new URLSearchParams(window.location.search);
        //console.log(urlParams.toString());
        var ticker = urlParams.get('tickerSymbol');
        //console.log(ticker);
        $('#tickerSymbol').val(ticker);
        //console.log($('#tickerSymbol').val());
        getData();
    });
	

	
   </script>
 
   </body>
</html>