<!DOCTYPE html>
<html>

<head>
    <style>

    </style>

    <script type='text/javascript' src='http://ajax.aspnetcdn.com/ajax/knockout/knockout-3.4.2.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>

    <p>Ticker Symbol: <input data-bind="value: tickerSymbol" /></p>
	    <div class="mypanel" ></div>
        <div class="mypanel1" ></div>
	    <div class="mypanel2" ></div>
		<div class="mypanel3" ></div>
    <div style='font-weight:bold; margin-bottom:10px'>
       <!-- <span>Today's Date: <span data-bind="text: todaysDate().format('YYYYMMDD') "></span></span>
        <span>Current Stock Date: <span data-bind="text: currentDate().format('YYYYMMDD') "></span></span>
        <span>Prev Stock Date: <span data-bind="text: prevDate().format('YYYYMMDD')"></span></span>
    </div>-->

    <div class = "chart" data-bind="if: tickerSymbol() !== undefined" class="container">
        <!-- ko foreach: computedQuery1() -->
        <img height="auto" width="auto" data-bind="attr: {src: $data }"></img>
        <!-- /ko -->
    </div>

    <div class = "pnf" data-bind="if: tickerSymbol() !== undefined" class="container">
        <!-- ko foreach: computedQuery2() -->
        <img data-bind="attr: {src: $data }"></img>
        <!-- /ko -->
    </div>

    <script>
	    
        var ViewModel = function () {
            var self = this;
			

            self.tickerSymbol = ko.observable();
			
				
				
				
				
				  $("p").change(function(){ 
								 
					 //
					     $.getJSON('https://api.iextrading.com/1.0/stock/'+self.tickerSymbol()+'/previous', function(data) {
        
									var text = `<font color="red">vwap: ${data.vwap}</font>`
                    
        
											$(".mypanel").html(text);
					});
					 //
						$.getJSON('https://api.iextrading.com/1.0/stock/'+self.tickerSymbol()+'/quote', function(data) {
									var text = `<b>Stock</b>: ${data.symbol}
									            Open: ${data.open}
												high: ${data.high}
												Low: ${data.low}
									            <font color="red">Price: ${data.latestPrice}</font>
												<font color="red"><b>change: ${data.change}</b></font>
												%: ${data.changePercent*100}
												Vol: ${data.latestVolume}`
												
																	
												
												
		          
        
											$(".mypanel1").html(text);
					});
					
						$.getJSON('https://api.iextrading.com/1.0/stock/'+self.tickerSymbol()+'/stats', function(data) {
										var text = `High52: ${data.week52high}
													Low52: ${data.week52low}
													Mov50: ${data.day50MovingAvg}
													Mov200: ${data.day200MovingAvg}`
		          
        
											$(".mypanel2").html(text);
					});
					 	$.getJSON('https://api.iextrading.com/1.0/stock/'+self.tickerSymbol()+'/stats', function(data) {
										var text = `<font color="red"><b>Ex-Dividend Date: ${data.exDividendDate}</b></font>
													shortInterest: ${data.shortInterest}
													shortDate: ${data.shortDate}`
		          
        
											$(".mypanel3").html(text);
					});
					
					
					
	});
            
			
			self.getWeekday = function (momentDate) {
                var returnDate = momentDate.clone();
                console.log(momentDate.format("YYYYMMDD"));
                while (returnDate.day() == 0 || returnDate.day() == 6) {
                    returnDate = returnDate.subtract(1, 'days');
                }
                return returnDate;
            };
			
		

				
			

            self.todaysDate = ko.observable(moment());
            self.currentDate = ko.observable(self.getWeekday(self.todaysDate().clone()));
            self.prevDate = ko.observable(self.getWeekday(self.currentDate().clone().subtract(1, 'days')));
            
            self.queryStrings1 = ko.observableArray([
			    "https://c.stockcharts.com/c-sc/sc?s={tickerSymbol}&p=D&b=5&g=1&i=p6792933477c&r=1547917550508",
				"https://c.stockcharts.com/c-sc/sc?s={tickerSymbol}&p=W&b=5&g=2&i=p1921549190c&r=1548398738916",
				"https://c.stockcharts.com/c-sc/sc?s={tickerSymbol}&p=W&b=5&g=2&i=p4597056426c&r=1548398896890",
                "https://c.stockcharts.com/c-sc/sc?s={tickerSymbol}&p=D&b=5&g=1&i=p8194948846c&r=1547615940766",
                "https://c.stockcharts.com/c-sc/sc?s={tickerSymbol}&p=D&b=5&g=1&i=p5016641587c&r=1547142826032",
                "https://c.stockcharts.com/c-sc/sc?s={tickerSymbol}&p=D&yr=2&mn=0&dy=0&i=p4398564585c&r=1547610432367",
				"https://c.stockcharts.com/c-sc/sc?s={tickerSymbol}&p=D&b=5&g=2&i=p2766788615c&r=1548907927521"
                
            ]);

            self.queryStrings2 = ko.observableArray([
                "https://c.stockcharts.com/pnf/chart?c={tickerSymbol},PWTIDANRBO[PA][D{date}][F1!3!!!2!20]&r=2113&pnf=y",
                "https://c.stockcharts.com/pnf/chart?c={tickerSymbol},PWPIDANRBO[PA][D{date}][F1!3!1.0!!2!20]&r=8447&pnf=y",
				"https://c.stockcharts.com/pnf/chart?c={tickerSymbol},PWAIFANRBO[PA][D{date}][F1!3!1.0!!2!20]&r=9909&pnf=y"
            ]);

            self.queryStrings1Computed = ko.observableArray();
            self.queryStrings2Computed = ko.observableArray();

            self.computedQuery1 = ko.computed(function () {
                var ticker = self.tickerSymbol();
                self.queryStrings1Computed.removeAll();
                self.queryStrings1().map(function (x) {
                    var base = x.replace("{tickerSymbol}", ticker);
                    self.queryStrings1Computed.push(base);                    
                });
                return self.queryStrings1Computed;
            }, this);

            self.computedQuery2 = ko.computed(function () {
                var ticker = self.tickerSymbol();
                self.queryStrings2Computed.removeAll();
                self.queryStrings2().map(function (x) {
                    var base = x.replace("{tickerSymbol}", ticker);
                    self.queryStrings2Computed.push(base.replace("{date}", self.currentDate().format("YYYYMMDD")));
                    self.queryStrings2Computed.push(base.replace("{date}", self.prevDate().format("YYYYMMDD")));
                });
                return self.queryStrings2Computed;
            }, this);            
		 };
	ko.applyBindings(new ViewModel()); 

       

        
		// iex begin

        // iex end		
		
		
    </script>
</body>

</html>